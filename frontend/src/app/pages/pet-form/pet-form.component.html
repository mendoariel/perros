<div class="pet-form-container">
  <!-- Loading State -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-content">
      <div class="loading-spinner">
        <svg class="spinner" viewBox="0 0 50 50">
          <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
        </svg>
      </div>
      <h3>{{ spinnerMessage }}</h3>
    </div>
  </div>

  <!-- Error State -->
  <div class="error-overlay" *ngIf="!isLoading && error">
    <div class="error-content">
      <div class="error-icon">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
      </div>
      <h3>Error</h3>
      <p>{{ error }}</p>
      <button class="btn-primary" (click)="goToMyPets()">Volver a Mis Mascotas</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" *ngIf="!isLoading && myPet">
    <!-- Header Section -->
    <div class="header-section">
      <div class="header-content">
        <div class="welcome-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
        </div>
        <h1>Completa el perfil de tu mascota</h1>
        <p class="welcome-text">
          Esta información aparecerá cuando alguien escanee su código QR
        </p>
      </div>
    </div>

    <!-- Form Card -->
    <div class="form-card">
      <!-- Form Section -->
      <div class="form-section">
        <form [formGroup]="petForm" class="simplified-form">
          <!-- Nombre de la Mascota -->
          <div class="form-group">
            <label for="petName">
              <span class="material-symbols-outlined label-icon">pets</span>
              Nombre de la mascota
            </label>
            <div class="input-wrapper">
              <input 
                type="text" 
                id="petName"
                formControlName="petName" 
                placeholder="Ej: Max, Luna, Toby"
                [class.error]="petName?.invalid && petName?.touched"
              >
            </div>
            <div class="error-message" *ngIf="petName?.invalid && petName?.touched">
              <span *ngIf="petName?.hasError('required')">El nombre es requerido</span>
              <span *ngIf="petName?.hasError('minlength')">Mínimo 2 caracteres</span>
              <span *ngIf="petName?.hasError('maxlength')">Máximo 50 caracteres</span>
            </div>
          </div>

          <!-- Descripción -->
          <div class="form-group">
            <label for="description">
              <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
              Descripción
            </label>
            <div class="input-wrapper">
              <textarea 
                id="description"
                formControlName="description" 
                placeholder="Describe características únicas de tu mascota que ayuden a identificarla..."
                rows="4"
                [class.error]="description?.invalid && description?.touched"
              ></textarea>
              <div class="char-counter" *ngIf="description?.value">
                {{ description?.value?.length || 0 }}/150
              </div>
            </div>
            <div class="error-message" *ngIf="description?.invalid && description?.touched">
              <span *ngIf="description?.hasError('required')">La descripción es requerida</span>
              <span *ngIf="description?.hasError('minlength')">Mínimo 3 caracteres</span>
              <span *ngIf="description?.hasError('maxlength')">Máximo 150 caracteres</span>
            </div>
          </div>

          <!-- Teléfono (Nuevo Campo) -->
          <div class="form-group">
            <label for="phoneNumber">
              <span class="material-symbols-outlined label-icon">phone</span>
              Teléfono de contacto
            </label>
            <div class="input-wrapper">
              <input 
                type="tel" 
                id="phoneNumber"
                formControlName="phoneNumber" 
                placeholder="Ej: 11 1234 5678"
                [class.error]="phoneNumber?.invalid && phoneNumber?.touched"
              >
            </div>
            <p class="field-hint">Este teléfono se guardará en tu perfil para que te contacten si encuentran a tu mascota.</p>
            <div class="error-message" *ngIf="phoneNumber?.invalid && phoneNumber?.touched">
              <span *ngIf="phoneNumber?.hasError('required')">El teléfono es requerido</span>
              <span *ngIf="phoneNumber?.hasError('invalidPhone')">{{ phoneNumber?.errors?.['invalidPhone']?.message }}</span>
              <span *ngIf="phoneNumber?.hasError('invalidPhoneLength')">{{ phoneNumber?.errors?.['invalidPhoneLength']?.message }}</span>
              <span *ngIf="phoneNumber?.hasError('invalidPhoneFormat')">{{ phoneNumber?.errors?.['invalidPhoneFormat']?.message }}</span>
            </div>
          </div>

          <!-- Image Upload Section -->
          <div class="form-group image-upload-section">
            <label>
              <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              Foto de la mascota <span class="required-indicator">*</span>
            </label>
            
            <div class="image-upload-wrapper">
              <!-- Upload Area -->
              <div class="upload-area" *ngIf="!myPet.image">
                <div class="upload-content">
                  <div class="upload-icon-wrapper">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="17 8 12 3 7 8"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                  </div>
                  <p class="upload-title">Agregar foto</p>
                  <p class="upload-subtitle">Una foto clara ayuda a identificar a tu mascota</p>
                  <input hidden (change)="onFileSelected($event)" #fileInput type="file" id="file" accept="image/*">
                  <button type="button" class="btn-upload" (click)="fileInput.click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="17 8 12 3 7 8"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    {{ textButton }}
                  </button>
                </div>
              </div>

              <!-- Current Image -->
              <div class="current-image-wrapper" *ngIf="myPet.image">
                <div class="image-preview">
                  <img [src]="env.perrosQrApi + 'pets/files/' + myPet.image" [alt]="myPet.petName || 'Mascota'">
                </div>
                <div class="image-actions">
                  <input hidden (change)="onFileSelected($event)" #fileInput type="file" id="file" accept="image/*">
                  <button type="button" class="btn-change-image" (click)="fileInput.click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Cambiar foto
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button 
              type="button"
              class="btn-cancel" 
              (click)="goToMyPets()"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Cancelar
            </button>
            <button 
              type="button"
              class="btn-save" 
              [disabled]="petForm.invalid || !myPet.image"
              (click)="updatePet()"
              [title]="petForm.invalid ? 'Por favor completa todos los campos requeridos' : (!myPet.image ? 'Debes agregar una imagen' : '')"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>