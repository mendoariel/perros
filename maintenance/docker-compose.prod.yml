version: "3.8"

services:
  postgres-emergency:
    image: postgres:15-alpine
    container_name: mi-perro-qr-postgres-emergency
    environment:
      - POSTGRES_USER=mendoariel
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=peludosclick
    # We will restore the backup manually or via a script on the server
    # to ensure we use the VERY LATEST production data.
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U mendoariel -d peludosclick" ]
      interval: 5s
      timeout: 5s
      retries: 5

  emergency-api:
    build:
      context: ./api
    container_name: mi-perro-qr-emergency-api
    environment:
      - DATABASE_URL=postgresql://mendoariel:password@postgres-emergency:5432/peludosclick
      - PORT=3000
    depends_on:
      postgres-emergency:
        condition: service_healthy
    networks:
      - app-network

  maintenance-perros:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mi-perro-qr-maintenance-1
    labels:
      - traefik.enable=true
      - traefik.http.routers.peludosclick_emergency.rule=Host(`www.peludosclick.com`,`peludosclick.com`)
      - traefik.http.routers.peludosclick_emergency.tls=true
      - traefik.http.routers.peludosclick_emergency.tls.certresolver=lets-encrypt
      - traefik.http.services.peludosclick_emergency.loadbalancer.server.port=80
    networks:
      - app-network
      - web

networks:
  app-network:
    name: mi-perro-qr_app-network
  web:
    external: true
